#!/usr/bin/env bb

(require '[babashka.process :refer [process]])
(require '[bb-utils :as u])
(require '[clojure.java.shell :as shell])

(let [dir (u/get-project-root!)
      base-env (u/get-env! "godot-clojure.dev.nrepl" "entry-fn")
      env (assoc base-env
                 "JAVA_HOME" "/nix/store/gi1zpnpwayp2qc1k6l4zvk10d934wy3s-openjdk-25.0.1+8/lib/openjdk")
      sh (fn [& args]
           (let [result (apply shell/sh (concat args [:dir dir :env env]))]
             (println result)
             (when (not= 0 (:exit result))
               (binding [*out* *err*]
                 (println "Non-zero exit code found, halting...")
                 (System/exit 1)))))]
  ;; 1) Build the JNI/GDExtension entry shared library (now lands in src/dummy_godot_project/entry.so)
  ;; find java home with fd -a "libjvm.so" /nix/store/gi1zpnpwayp2qc1k6l4zvk10d934wy3s-openjdk-25.0.1+8
  ;; after doing (in bash) 'dirname $(dirname $(readlink -f $(which godot)))'
  (sh "make")

  ;; 2) Export the dummy project (needs an editor build; --headless avoids opening a window) [page:0]
  (sh "godot"
      "--headless"
      "--path" "src/dummy_godot_project"
      "--export-debug" "Linux/X11")

  ;; 3) Run the exported binary in the foreground
  (let [p (process {:inherit true
                    :dir dir
                    :env env}
                   "./src/dummy_godot_project/test_project.x86_64"
                   "--headless"
                   "--verbose"
                   "--quit-after" "2")]
    (System/exit (:exit @p))))
